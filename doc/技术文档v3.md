# Mac AI Toolkit - 架构设计文档

**版本：** v3.0  
**架构：** Mac App (GUI + Service) + SDK  
**作者：** clleon  
**日期：** 2026年1月

---

## 1. 产品概述

### 1.1 产品定义

**Mac AI Toolkit** 是一款 Mac 原生应用，将 macOS 系统 AI 能力（Vision、Speech、AVFoundation）封装为：
1. **GUI 应用** - 普通用户可直接使用
2. **本地 API 服务** - 开发者可通过 SDK/CLI 调用

### 1.2 核心价值

| 用户类型 | 价值 |
|----------|------|
| **普通用户** | 无需技术背景，通过 GUI 直接使用 OCR、TTS、STT 功能 |
| **开发者** | 无需学习 Swift，通过 HTTP API / SDK / MCP 快速集成 Mac AI 能力 |
| **企业** | 完全本地运行，数据不出设备，零 API 费用 |

### 1.3 Slogan

> **"One App, All Mac AI"**

---

## 2. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                   │
│                                                                 │
│   👤 普通用户                        👨‍💻 开发者                    │
│   ┌─────────────┐          ┌─────────┬─────────┬─────────┐     │
│   │   Mac App   │          │ TS SDK  │ Py SDK  │   MCP   │     │
│   │    (GUI)    │          │ (npm)   │  (pip)  │ Server  │     │
│   └──────┬──────┘          └────┬────┴────┬────┴────┬────┘     │
└──────────┼──────────────────────┼─────────┼─────────┼───────────┘
           │ 直接使用              │         │         │
           │                      └─────────┴─────────┘
           │                              │
           │                    HTTP (localhost:19527)
           │                              │
┌──────────┼──────────────────────────────┼───────────────────────┐
│          ▼                              ▼                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                 Mac AI Toolkit.app                       │   │
│  │                                                          │   │
│  │  ┌─────────────────────┐    ┌─────────────────────────┐  │   │
│  │  │      GUI Layer      │    │     Service Layer       │  │   │
│  │  │                     │    │                         │  │   │
│  │  │  • 主窗口界面        │    │  ┌───────────────────┐  │  │   │
│  │  │  • 菜单栏快捷入口    │◄──►│  │   HTTP Server     │  │  │   │
│  │  │  • 快捷键支持        │    │  │  localhost:19527  │  │  │   │
│  │  │  • 拖拽处理         │    │  └───────────────────┘  │  │   │
│  │  │  • 历史记录         │    │                         │  │   │
│  │  └─────────────────────┘    └─────────────────────────┘  │   │
│  │                     │                    │               │   │
│  │                     ▼                    ▼               │   │
│  │  ┌───────────────────────────────────────────────────┐   │   │
│  │  │                  Core Services                    │   │   │
│  │  │                                                   │   │   │
│  │  │   ┌─────────┐   ┌─────────┐   ┌─────────┐        │   │   │
│  │  │   │   OCR   │   │   TTS   │   │   STT   │        │   │   │
│  │  │   │ Service │   │ Service │   │ Service │        │   │   │
│  │  │   └────┬────┘   └────┬────┘   └────┬────┘        │   │   │
│  │  └────────┼─────────────┼─────────────┼─────────────┘   │   │
│  └───────────┼─────────────┼─────────────┼─────────────────┘   │
│              │             │             │                     │
│              ▼             ▼             ▼                     │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    macOS Frameworks                       │ │
│  │                                                           │ │
│  │    Vision    │   AVFoundation   │   Speech   │  Core ML   │ │
│  └───────────────────────────────────────────────────────────┘ │
│                          系统层                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Mac App 设计

### 3.1 应用形态

Mac AI Toolkit 是一个 **混合形态应用**：

| 形态 | 说明 |
|------|------|
| **主窗口** | 完整 GUI 界面，提供所有功能的可视化操作 |
| **菜单栏图标** | 常驻状态指示 + 快捷操作入口 |
| **后台服务** | HTTP Server 持续运行，响应 API 请求 |

### 3.2 GUI 功能模块

```
┌─────────────────────────────────────────────────────────────────┐
│  Mac AI Toolkit                                    [—] [□] [×]  │
├────────────┬────────────────────────────────────────────────────┤
│            │                                                    │
│  📝 OCR    │   ┌──────────────────────────────────────────┐    │
│            │   │                                          │    │
│  🔊 TTS    │   │     拖拽图片到此处 或 点击选择文件         │    │
│            │   │                                          │    │
│  🎤 STT    │   │            📁 选择图片                   │    │
│            │   │                                          │    │
│  ─────────  │   └──────────────────────────────────────────┘    │
│            │                                                    │
│  ⚙️ 设置   │   语言: [中文简体 ▼]  模式: [精确 ▼]              │
│            │                                                    │
│  📜 历史   │   ┌──────────────────────────────────────────┐    │
│            │   │                                          │    │
│            │   │  识别结果将显示在这里...                   │    │
│            │   │                                          │    │
│            │   │                                          │    │
│            │   └──────────────────────────────────────────┘    │
│            │                                                    │
│            │   [📋 复制文本]  [💾 保存文件]  [🔄 清空]          │
│            │                                                    │
└────────────┴────────────────────────────────────────────────────┘
```

#### 3.2.1 OCR 模块

**功能：**
- 拖拽/选择图片进行文字识别
- 截图识别（快捷键触发）
- 剪贴板图片识别
- 支持多语言选择
- 识别结果编辑/复制/保存
- 批量图片处理

**快捷键：**
| 快捷键 | 功能 |
|--------|------|
| `⌘ + Shift + O` | 截图 OCR |
| `⌘ + V` | 识别剪贴板图片 |

#### 3.2.2 TTS 模块

**功能：**
- 输入文本转换为语音
- 语音选择（系统可用语音列表）
- 参数调节（语速、音调、音量）
- 实时预览播放
- 导出音频文件（MP3/WAV）
- 批量文本转换

**界面：**
```
┌──────────────────────────────────────────────────────────┐
│  输入文本:                                               │
│  ┌────────────────────────────────────────────────────┐  │
│  │  在此输入要转换的文字...                            │  │
│  │                                                    │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
│  语音: [Ting-Ting (中文) ▼]                              │
│                                                          │
│  语速: ──────●────────── 0.5                            │
│  音调: ────────●──────── 1.0                            │
│  音量: ──────────────●── 0.8                            │
│                                                          │
│  [▶️ 预览播放]    [💾 导出 MP3]    [💾 导出 WAV]          │
└──────────────────────────────────────────────────────────┘
```

#### 3.2.3 STT 模块

**功能：**
- 录音转文字（实时录制）
- 音频文件转文字（拖拽/选择）
- 支持多语言识别
- 分段显示（带时间戳）
- 结果编辑/导出

**界面：**
```
┌──────────────────────────────────────────────────────────┐
│                                                          │
│  ┌─────────────────┐    ┌─────────────────────────────┐  │
│  │                 │    │                             │  │
│  │   🎙️ 点击录音   │ 或 │  拖拽音频文件到此处          │  │
│  │                 │    │                             │  │
│  └─────────────────┘    └─────────────────────────────┘  │
│                                                          │
│  语言: [中文普通话 ▼]    □ 仅本地识别                    │
│                                                          │
│  识别结果:                                               │
│  ┌────────────────────────────────────────────────────┐  │
│  │  [00:00] 这是识别出来的文字内容                     │  │
│  │  [00:03] 支持分段显示和时间戳                       │  │
│  │  [00:05] ...                                       │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
│  [📋 复制全部]    [💾 导出 TXT]    [💾 导出 SRT]          │
└──────────────────────────────────────────────────────────┘
```

#### 3.2.4 设置模块

**配置项：**

| 类别 | 配置项 |
|------|--------|
| **通用** | 开机自启、语言、主题（浅色/深色/跟随系统）|
| **API 服务** | 端口号、启用/禁用、认证密钥 |
| **OCR** | 默认语言、默认识别模式 |
| **TTS** | 默认语音、默认语速 |
| **STT** | 默认语言、本地识别优先 |
| **快捷键** | 自定义全局快捷键 |
| **存储** | 历史记录保留天数、默认导出路径 |

#### 3.2.5 历史记录

**功能：**
- 按时间/类型浏览历史操作
- 搜索历史记录
- 重新处理历史项
- 批量导出/删除

### 3.3 菜单栏设计

```
┌────────────────────────────────┐
│  [🤖]  ← 点击展开菜单           │
├────────────────────────────────┤
│  ● 服务运行中                   │
│  ─────────────────────         │
│  📝 快速 OCR（截图）    ⌘⇧O    │
│  🔊 快速 TTS（剪贴板）  ⌘⇧T    │
│  🎤 快速 STT（录音）    ⌘⇧S    │
│  ─────────────────────         │
│  📊 今日统计: 23 次请求         │
│  ─────────────────────         │
│  🖥️ 打开主窗口          ⌘⇧M    │
│  ⚙️ 设置...                     │
│  📖 帮助文档                    │
│  ─────────────────────         │
│  退出                          │
└────────────────────────────────┘
```

### 3.4 技术架构

```
MacAIToolkit/
├── App/
│   ├── MacAIToolkitApp.swift         # 应用入口
│   ├── AppDelegate.swift             # 生命周期管理
│   └── AppState.swift                # 全局状态管理
│
├── Views/                            # SwiftUI 视图
│   ├── MainWindow/
│   │   ├── MainView.swift            # 主窗口
│   │   ├── SidebarView.swift         # 侧边栏导航
│   │   ├── OCRView.swift             # OCR 界面
│   │   ├── TTSView.swift             # TTS 界面
│   │   ├── STTView.swift             # STT 界面
│   │   ├── HistoryView.swift         # 历史记录
│   │   └── SettingsView.swift        # 设置界面
│   │
│   └── MenuBar/
│       ├── MenuBarView.swift         # 菜单栏弹出窗
│       └── StatusItemManager.swift   # 状态栏管理
│
├── Services/                         # 核心服务
│   ├── OCRService.swift              # Vision OCR 封装
│   ├── TTSService.swift              # AVSpeechSynthesizer 封装
│   ├── STTService.swift              # SFSpeechRecognizer 封装
│   └── HistoryService.swift          # 历史记录管理
│
├── Server/                           # HTTP API 服务
│   ├── HTTPServer.swift              # Vapor 服务器
│   ├── Routes/
│   │   ├── OCRRoutes.swift
│   │   ├── TTSRoutes.swift
│   │   ├── STTRoutes.swift
│   │   └── HealthRoutes.swift
│   └── Middleware/
│       ├── AuthMiddleware.swift
│       └── LoggingMiddleware.swift
│
├── Models/                           # 数据模型
│   ├── OCRModels.swift
│   ├── TTSModels.swift
│   ├── STTModels.swift
│   └── HistoryModels.swift
│
├── Utils/                            # 工具类
│   ├── ImageUtils.swift
│   ├── AudioUtils.swift
│   ├── FileManager+Extensions.swift
│   └── KeyboardShortcuts.swift
│
└── Resources/
    ├── Assets.xcassets
    ├── Localizable.strings           # 多语言
    └── Info.plist
```

### 3.5 技术选型

| 组件 | 技术 | 说明 |
|------|------|------|
| UI 框架 | SwiftUI | 现代声明式 UI |
| HTTP Server | Vapor | Swift 原生 Web 框架 |
| 数据持久化 | SwiftData / Core Data | 历史记录存储 |
| 快捷键 | HotKey | 全局快捷键支持 |
| 状态管理 | Combine + Observable | 响应式状态 |

---

## 4. API 服务设计

### 4.1 服务概述

Mac App 内置 HTTP Server，监听 `localhost:19527`，为 SDK/CLI/MCP 提供 API 服务。

### 4.2 API 端点

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/health` | 健康检查 |
| POST | `/ocr` | 文字识别 |
| POST | `/tts` | 文字转语音 |
| GET | `/tts/voices` | 获取可用语音列表 |
| POST | `/stt` | 语音转文字 |

### 4.3 请求/响应格式

#### OCR

**Request:**
```
POST /ocr
Content-Type: multipart/form-data

image: <file>
language: zh-Hans (可选)
recognitionLevel: accurate | fast (可选)
detailed: true | false (可选)
```

**Response:**
```json
{
  "text": "识别的文字内容",
  "confidence": 0.95,
  "language": "zh-Hans",
  "blocks": [...]
}
```

#### TTS

**Request:**
```
POST /tts
Content-Type: application/json

{
  "text": "要转换的文字",
  "voice": "com.apple.voice.xxx",
  "language": "zh-CN",
  "rate": 0.5,
  "outputFormat": "mp3"
}
```

**Response:**
```
Content-Type: audio/mpeg
<binary audio data>
```

#### STT

**Request:**
```
POST /stt
Content-Type: multipart/form-data

audio: <file>
language: zh-CN (可选)
```

**Response:**
```json
{
  "text": "识别的文字内容",
  "confidence": 0.92,
  "segments": [
    {
      "text": "识别的",
      "timestamp": 0.0,
      "duration": 0.5
    }
  ]
}
```

### 4.4 错误响应

```json
{
  "error": {
    "code": "INVALID_IMAGE",
    "message": "Cannot decode image data"
  }
}
```

---

## 5. SDK 设计

### 5.1 TypeScript SDK

**包名：** `@mac-ai-toolkit/sdk`

**核心 API：**

```typescript
import { MacAI } from '@mac-ai-toolkit/sdk'

const ai = new MacAI()

// OCR
const result = await ai.ocr('./image.png', { language: 'zh-Hans' })

// TTS
const audio = await ai.tts('Hello World', { voice: 'Samantha' })

// STT
const text = await ai.stt('./audio.wav', { language: 'en-US' })

// 健康检查
const isRunning = await ai.isAvailable()
```

**项目结构：**
```
packages/sdk-typescript/
├── src/
│   ├── index.ts          # 入口
│   ├── client.ts         # MacAI 类
│   ├── types/            # 类型定义
│   └── errors.ts         # 错误类
├── package.json
└── README.md
```

### 5.2 Python SDK

**包名：** `mac-ai-toolkit`

**核心 API：**

```python
from mac_ai_toolkit import MacAI

ai = MacAI()

# OCR
result = ai.ocr('./image.png', language='zh-Hans')

# TTS
audio = ai.tts('Hello World', voice='Samantha')

# STT
text = ai.stt('./audio.wav', language='en-US')
```

**项目结构：**
```
packages/sdk-python/
├── mac_ai_toolkit/
│   ├── __init__.py
│   ├── client.py
│   ├── types.py
│   └── errors.py
├── setup.py
└── README.md
```

---

## 6. MCP Server 设计

### 6.1 概述

MCP Server 让 Claude Desktop 可以直接调用 Mac AI 能力。

### 6.2 可用工具

| 工具名 | 功能 | 参数 |
|--------|------|------|
| `ocr` | 识别图片文字 | imagePath, language |
| `tts` | 文字转语音 | text, language, outputPath |
| `stt` | 语音转文字 | audioPath, language |
| `list_voices` | 列出可用语音 | - |

### 6.3 Claude Desktop 配置

```json
{
  "mcpServers": {
    "mac-ai-toolkit": {
      "command": "npx",
      "args": ["-y", "@mac-ai-toolkit/mcp"]
    }
  }
}
```

### 6.4 使用示例

在 Claude 对话中：

```
用户: 帮我识别这张图片上的文字 /path/to/image.png

Claude: [调用 ocr 工具]
识别结果: ...

用户: 把这段文字转成语音

Claude: [调用 tts 工具]
音频已保存到: /tmp/tts-xxx.mp3
```

---

## 7. CLI 设计

### 7.1 命令结构

```bash
mac-ai <command> [options]

Commands:
  ocr <image>       识别图片文字
  tts <text>        文字转语音
  stt <audio>       语音转文字
  voices            列出可用语音
  status            检查服务状态

Global Options:
  -h, --help        显示帮助
  -v, --version     显示版本
  --json            JSON 格式输出
```

### 7.2 使用示例

```bash
# OCR
mac-ai ocr screenshot.png
mac-ai ocr document.png --language zh-Hans --detailed

# TTS
mac-ai tts "Hello World" -o output.mp3
mac-ai tts "你好世界" --language zh-CN --voice Ting-Ting

# STT
mac-ai stt recording.wav
mac-ai stt meeting.m4a --language en-US --json

# 状态检查
mac-ai status
```

---

## 8. 分发策略

### 8.1 Mac App 分发

| 渠道 | 优点 | 缺点 |
|------|------|------|
| **Mac App Store** | 用户信任、自动更新 | 审核慢、30% 抽成、沙盒限制 |
| **官网 DMG** | 灵活、无抽成 | 需要签名公证 |
| **Homebrew Cask** | 开发者友好 | 需维护 formula |

**推荐：** 官网 DMG + Homebrew Cask 双渠道

### 8.2 SDK/CLI 分发

| 包 | 分发渠道 |
|------|----------|
| TypeScript SDK | npm (`@mac-ai-toolkit/sdk`) |
| Python SDK | PyPI (`mac-ai-toolkit`) |
| MCP Server | npm (`@mac-ai-toolkit/mcp`) |
| CLI | npm (`@mac-ai-toolkit/cli`) + Homebrew |

### 8.3 定价策略

| 版本 | 价格 | 功能 |
|------|------|------|
| **Free** | $0 | GUI 基础功能、API 每日 100 次调用 |
| **Pro** | $29 一次性 | 无限 API 调用、批量处理、快捷键自定义、优先支持 |

---

## 9. 开发路线图

### Phase 1: MVP (Week 1-3)

**目标：** 可用的 App + SDK

- [ ] Mac App 基础框架
- [ ] OCR 服务 + GUI
- [ ] HTTP Server
- [ ] TypeScript SDK
- [ ] 基础文档

### Phase 2: 完整功能 (Week 4-6)

**目标：** 功能完整

- [ ] TTS 服务 + GUI
- [ ] STT 服务 + GUI
- [ ] 历史记录
- [ ] MCP Server
- [ ] CLI 工具
- [ ] Python SDK

### Phase 3: 打磨 (Week 7-8)

**目标：** 生产就绪

- [ ] 设置面板完善
- [ ] 快捷键支持
- [ ] 多语言 UI
- [ ] 性能优化
- [ ] 完整测试
- [ ] 签名公证

### Phase 4: 发布 (Week 9+)

**目标：** 上线推广

- [ ] 官网上线
- [ ] Product Hunt
- [ ] 社区推广
- [ ] 用户反馈迭代

---

## 10. 技术要求

### 10.1 系统要求

| 项目 | 要求 |
|------|------|
| macOS | 13.0 (Ventura) 或更高 |
| 芯片 | Apple Silicon 或 Intel |
| 存储 | 约 50MB |

### 10.2 开发环境

| 工具 | 版本 |
|------|------|
| Xcode | 15+ |
| Swift | 5.9+ |
| Node.js | 18+ |
| Python | 3.9+ |

### 10.3 依赖框架

**Swift:**
- Vision (OCR)
- AVFoundation (TTS)
- Speech (STT)
- Vapor (HTTP Server)
- SwiftUI (GUI)

**Node.js:**
- @modelcontextprotocol/sdk (MCP)
- commander (CLI)

---

## 附录

### A. 支持的语言

**OCR:** en-US, zh-Hans, zh-Hant, ja-JP, ko-KR, fr-FR, de-DE, es-ES, it-IT, pt-BR, ru-RU 等 16+ 语言

**TTS:** 取决于系统安装的语音包（可通过 API 查询）

**STT:** en-US, zh-CN, zh-TW, ja-JP, ko-KR 等 50+ 语言区域

### B. 权限说明

| 权限 | 用途 |
|------|------|
| 语音识别 | STT 功能需要 |
| 麦克风 | 实时录音转文字 |
| 网络（本地） | HTTP Server 监听 |

---

**文档结束**
